<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with Our AI Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ------------------------------ */
    /* Chatbot Container Base Styles  */
    /* ------------------------------ */
    #chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-family: sans-serif;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    /* Minimized state: circle (60x60) with a bright gradient */
    #chatbot-container.minimized {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff4088, #ff80ab);
      box-shadow: 0 4px 8px rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    /* Expanded state: rectangular chat window (300px wide) */
    #chatbot-container.expanded {
      width: 300px;
      border-radius: 8px;
      background: #1f2937;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    /* ------------------------------ */
    /* Minimized Icon vs. Full Content */
    /* ------------------------------ */
    /* In minimized state, show only the icon */
    #chatbot-icon {
      display: block;
    }
    /* Hide the full chat content when minimized */
    #chatbot-content {
      display: none;
    }
    /* When expanded, hide the icon and show full content */
    #chatbot-container.expanded #chatbot-icon {
      display: none;
    }
    #chatbot-container.expanded #chatbot-content {
      display: block;
    }

    /* ------------------------------ */
    /* Chat Icon (Minimized State)    */
    /* ------------------------------ */
    #chatbot-icon img {
      width: 40px;
      height: 40px;
      filter: brightness(1.2);
    }

    /* ------------------------------ */
    /* Chat Content Styles            */
    /* ------------------------------ */
    #chatbot-header {
      background: #4f46e5;
      padding: 10px;
      text-align: center;
      position: relative;
      cursor: pointer;
    }
    /* Header displays the M3S logo */
    #chatbot-header img {
      max-height: 40px;
      vertical-align: middle;
    }
    /* Toggle icon in the header */
    #chatbot-header .toggle-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }
    /* Notification badge styling */
    #chat-notification {
      position: absolute;
      top: 5px;
      left: 10px;
      background: red;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      text-align: center;
      line-height: 16px;
      display: none;
    }
    /* Chat log area */
    #chat-log {
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #111827;
      color: #d1d5db;
    }
    .message {
      margin-bottom: 10px;
      padding: 5px 8px;
      border-radius: 4px;
    }
    .message.user {
      background: #3b82f6;
      text-align: right;
    }
    .message.bot {
      background: #6b7280;
      text-align: left;
    }
    /* Loading spinner styling */
    .message.loading {
      display: flex;
      align-items: center;
      font-style: italic;
      opacity: 0.7;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4f46e5;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Chat input area */
    #chat-input-container {
      display: flex;
      border-top: 1px solid #374151;
    }
    #chat-input {
      flex: 1;
      border: none;
      padding: 10px;
      outline: none;
      background: #1f2937;
      color: #d1d5db;
    }
    #chat-send {
      background: #4f46e5;
      border: none;
      color: white;
      padding: 0 15px;
      cursor: pointer;
    }
    /* ------------------------------ */
    /* Booking Link Styling (Classy)  */
    /* ------------------------------ */
    .booking-link {
      color: #fff;
      background: transparent;
      border: 1px solid #fff;
      padding: 4px 8px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.8em;
      font-weight: 400;
    }
    .booking-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <!-- Chatbot Widget Container -->
  <div id="chatbot-container" class="minimized">
    <!-- Minimized State: Circle with Logo Icon -->
    <div id="chatbot-icon">
      <img src="https://pub-63c6a647b6f740e885a4d0b9305248e3.r2.dev/defaults/logo_m3s.png" alt="M3S Logo">
    </div>
    <!-- Expanded State: Full Chat Content -->
    <div id="chatbot-content">
      <div id="chatbot-header">
        <img src="https://pub-63c6a647b6f740e885a4d0b9305248e3.r2.dev/defaults/logo_m3s.png" alt="M3S Services Logo">
        <span id="chat-notification">!</span>
        <span class="toggle-icon">▼</span>
      </div>
      <div id="chat-log"></div>
      <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type your message..." />
        <button id="chat-send">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Cloudflare Worker URL and API key.
    // Ensure that the API key here ("sk-abc123") matches your Worker environment.
    const WORKER_URL = 'https://m3schatbot.gauranshtandon.workers.dev/';
    const API_KEY = 'sk-1a9d8c642b7e53091f23g6hilk5nom47';

    // Get references to DOM elements.
    const chatbotContainer = document.getElementById('chatbot-container');
    const chatbotContent = document.getElementById('chatbot-content');
    const chatbotIcon = document.getElementById('chatbot-icon');
    const chatbotHeader = document.getElementById('chatbot-header');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const toggleIcon = chatbotHeader.querySelector('.toggle-icon');
    const chatNotification = document.getElementById('chat-notification');

    let isMinimized = true;
    let unreadCount = 0;
    // Fallback conversation state:
    // "initial" – no conversation yet; any first input is treated as greeting.
    // "contact" – chatbot has asked for email or name.
    // "done" – conversation complete; booking info provided.
    let fakeConversationState = "initial";

    // Toggle function: always toggle between minimized (circle) and expanded (rectangle).
    function toggleChat() {
      if (isMinimized) {
        // Expand the widget.
        chatbotContainer.classList.remove('minimized');
        chatbotContainer.classList.add('expanded');
        chatbotIcon.style.display = 'none';
        chatbotContent.style.display = 'block';
        toggleIcon.textContent = '▼';
        isMinimized = false;
      } else {
        // Collapse the widget.
        chatbotContainer.classList.remove('expanded');
        chatbotContainer.classList.add('minimized');
        chatbotIcon.style.display = 'block';
        chatbotContent.style.display = 'none';
        toggleIcon.textContent = '▲';
        isMinimized = true;
      }
    }
    // Attach toggle event to the container (except for input and send button clicks).
    chatbotContainer.addEventListener('click', (e) => {
      if (e.target.id !== 'chat-input' && e.target.id !== 'chat-send') {
        toggleChat();
      }
    });

    // Append a message to the chat log.
    // For bot messages, we set innerHTML to allow clickable links.
    function appendMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      if (sender === 'bot') {
        messageDiv.innerHTML = text;
      } else {
        messageDiv.textContent = text;
      }
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Fallback conversation logic.
    function getFakeResponse(userInput) {
      const input = userInput.toLowerCase().trim();
      if (fakeConversationState === "initial") {
        fakeConversationState = "contact";
        return "Hi there, welcome to M3S Services! How can we help you today? Please share your email or name so we can assist you further.";
      } else if (fakeConversationState === "contact") {
        if (input === "no" || input.includes("not interested") || input.includes("no thanks") || input === "nah") {
          fakeConversationState = "done";
          return "Understood. If you change your mind, you can always <a href='https://cal.com/m3sservices/30min' target='_blank' class='booking-link'>BOOK A CALL HERE</a>.";
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(input) || input.length >= 3) {
          fakeConversationState = "done";
          return "Thank you! Please, <a href='https://cal.com/m3sservices/30min' target='_blank' class='booking-link'>BOOK A CALL HERE</a>";
        }
        return "Could you please provide a valid email address or your name so we can assist you further?";
      } else {
        return "For further assistance, please <a href='https://cal.com/m3sservices/30min' target='_blank' class='booking-link'>BOOK A CALL HERE</a>.";
      }
    }

    // Function to send the user's prompt to the Cloudflare Worker.
    async function sendMessage(prompt) {
      const data = { prompt: prompt };
      try {
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-KEY': API_KEY
          },
          body: JSON.stringify(data)
        });
        console.log('Response status:', response.status);
        if (!response.ok) {
          const errorText = await response.text();
          console.error("Response not OK:", errorText);
          return "Sorry, something went wrong.";
        }
        try {
          const jsonResponse = await response.json();
          console.log('Raw JSON response:', jsonResponse);
          if (jsonResponse.response && typeof jsonResponse.response.response === 'string') {
            return jsonResponse.response.response;
          }
          console.error("JSON structure is not as expected:", jsonResponse);
          return "Sorry, something went wrong.";
        } catch (jsonError) {
          const text = await response.text();
          console.error('Error parsing JSON:', jsonError, 'Response text:', text);
          return "Sorry, something went wrong.";
        }
      } catch (error) {
        console.error('Fetch error:', error);
        return "Sorry, something went wrong.";
      }
    }

    // Event listener for the Send button.
    chatSend.addEventListener('click', async (e) => {
      e.stopPropagation();
      const prompt = chatInput.value.trim();
      if (!prompt) return;
      appendMessage('user', prompt);
      chatInput.value = '';

      // Append a loading message with spinner.
      const loadingMessage = document.createElement('div');
      loadingMessage.classList.add('message', 'bot', 'loading');
      loadingMessage.innerHTML = '<span class="spinner"></span>Loading...';
      chatLog.appendChild(loadingMessage);
      chatLog.scrollTop = chatLog.scrollHeight;

      // Try to get the API response.
      let reply = await sendMessage(prompt);
      if (reply === "Sorry, something went wrong.") {
        reply = getFakeResponse(prompt);
      }
      
      chatLog.removeChild(loadingMessage);
      appendMessage('bot', reply);

      if (isMinimized) {
        unreadCount++;
        chatNotification.textContent = unreadCount;
        chatNotification.style.display = 'block';
      }
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        chatSend.click();
      }
    });
  </script>
  <!-- Booking link styling -->
  <style>
    .booking-link {
      color: #fff;
      background:  #ec1aff;
      border: 1px solid #fff;
      padding: 4px 8px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.8em;
      font-weight: 400;
    }
    .booking-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</body>
</html>